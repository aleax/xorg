#!/bin/sh
# Debian xserver-xorg package post-installation script
# Copyright 1998-2004 Branden Robinson.
# Copyright 2004-2005 Canonical Ltd.
# Licensed under the GNU General Public License, version 2.  See the file
# /usr/share/common-licenses/GPL or <http://www.gnu.org/copyleft/gpl.txt>.
# Acknowledgements to Stephen Early, Mark Eichin, and Manoj Srivastava.

set -e

# source debconf library
. /usr/share/debconf/confmodule

THIS_PACKAGE=xserver-xorg
THIS_SCRIPT=postinst

#INCLUDE_SHELL_LIB#

if [ -e /etc/default/xorg ]; then
  . /etc/default/xorg
fi

if [ "x$XORG_CONFIG" = "xcustom" ]; then
  # leave configuration alone
  warn "not updating configuration as per \$XORG_CUSTOM"
  exit 0
fi

# the error-out function
bomb () {
  echo "$PROGNAME: error: $*" | fold -s -w "${COLUMNS:-80}" >&2
  exit 1
}

debug_echo () {
  # Syntax: debug_echo message ...
  if [ -n "$DEBUG_XORG_DEBCONF" ] || [ "$DEBCONF_DEBUG" = "user" ] \
    || [ "$DEBCONF_DEBUG" = '.*' ]; then
    DEBUG_XORG_PACKAGE="yes" observe "$*"
  fi
}

validate_string_db_input () {
  # Syntax: validate_string_db_input priority template
  #
  # validate string input; can't have doublequotes
  # If $MAY_BE_NULL is a non-null value (e.g., "yes"), the string may be null.
  if [ $# -ne 2 ]; then
    echo "internal error: validate_string_db_input() called with wrong number of arguments: $*" >&2
    exit 1
  fi
  PRIORITY="$1"
  TEMPLATE="$2"
  db_get "$TEMPLATE"
  SAFE="$RET"
  set +e
  while :; do
    db_input "$PRIORITY" "$TEMPLATE" || debug_echo "v_s_d_i/db_input $PRIORITY $TEMPLATE"
    # is the question going to be asked?
    if [ $? -eq 30 ]; then
      break # no; bail out of validation loop
    fi
    db_go
    db_get "$TEMPLATE"
    if [ -n "$RET" ]; then
      if ! expr "$RET" : '.*".*' > /dev/null 2>&1; then
        break # valid input
      else
        ERROR="xserver-xorg/config/doublequote_in_string_error"
      fi
    else
      if [ -n "$MAY_BE_NULL" ]; then
        break # valid (null) input
      else
        ERROR="xserver-xorg/config/null_string_error"
      fi
    fi
    # we only get to this point if the input was invalid; restore the known
    # good value in case we are interrupted before the user provides a valid
    # one
    db_set "$TEMPLATE" "$SAFE"
    db_fset "$TEMPLATE" seen false
    # now show the user the error message
    db_fset "$ERROR" seen false
    db_input critical "$ERROR"
    db_go
  done
  set -e
}

validate_monitor_frequency_expr () {
  # syntax: validate_monitor_frequency_expr expression
  #
  # Confirm that the given expression is a valid monitor frequency expression
  # per XF86Config-4(5x).  Note that this does *not* handle (comma-delimited)
  # tuples.  We expect a single value or range with an optional unit suffix.
  #
  # Note: We don't check to see if the latter value in a range is actually
  # greater than the former, and we don't check to see if any of the numeric
  # values actually make sense.  I.e., 0 Hz may not actually be valid as far as
  # the X server is concerned, but 10000 Hz might be okay whereas 10000 kHz
  # might not be.  It would take quite a bit of code to sort all that out.  We
  # only take some of the bullets out of the user's gun -- not all of them.
  #
  # Return true (0) if the expression is valid, and false (1) if it is not.

  _func="validate_monitor_frequency_expr"

  # Validate function arguments.
  if [ $# -ne 1 ]; then
    internal_error "$_func(): called with wrong number of arguments; expected" \
                   "1, got $@"
  fi

  _regex='^[[:space:]]*0*[0-9]+(\.[0-9]+)?(-0*[0-9]+(\.[0-9]+)?)?([[:space:]]*[kM]?Hz)?$'

  if echo "$1" | grep -Eiq "$_regex"; then
    return 0
  else
    return 1
  fi
}

validate_monitor_frequency_db_input () {
  # syntax: validate_monitor_frequency_db_input priority template
  #
  # validate monitor frequency input

  _func="validate_monitor_frequency_db_input"

  # Validate function arguments.
  if [ $# -ne 2 ]; then
    internal_error "$_func(): called with wrong number of arguments; expected" \
                   "2, got $@"
  fi

  _priority=$1
  _template=$2
  db_get "$_template"
  _safe="$RET"
  set +e
  while :; do
    db_input "$_priority" "$_template"
    # is the question going to be asked?
    if [ $? -eq 30 ]; then
      break # no; bail out of validation loop
    fi
    db_go
    db_get "$_template"
    # This is a string, and needs input validation; a regex match will have to
    # do.  We force the first character to be a number to avoid hideous problems
    # in the debconf dialog frontend in 0.3.83 (it needs to be one anyway).  We
    # need to handle multiple expressions, delimited by commas.  See
    # XF86Config-4(5x) for more information.
    if expr "$RET" : ".*,.*" >/dev/null 2>&1; then
      _expr_is_valid=true
        echo "$RET" | tr -s ',' '\n' | while read _freq_expr; do
          if ! validate_monitor_frequency_expr "$_freq_expr"; then
            _expr_is_valid=
          fi
        done
        if [ -n "$_expr_is_valid" ]; then
          break
        fi
    else
      if validate_monitor_frequency_expr "$RET"; then
        break
      fi
    fi

    # we only get to this point if the input was invalid; restore the known
    # good value in case we are interrupted before the user provides a
    # valid one
    db_set "$_template" "$_safe"
    db_fset "$_template" seen false
    # now show the user the error message
    db_fset xserver-xorg/config/monitor/range_input_error seen false
    db_input critical xserver-xorg/config/monitor/range_input_error
    db_go
  done
  set -e
}

CONFIG_DIR="/etc/X11"
SERVER_SYMLINK="$CONFIG_DIR/X"
XF86CONFIG="$CONFIG_DIR/XF86Config-4"
XORGCONFIG="$CONFIG_DIR/xorg.conf"
CONFIG_AUX_DIR="/var/lib/x11"
SERVER_SYMLINK_CHECKSUM="$CONFIG_AUX_DIR/${SERVER_SYMLINK##*/}.md5sum"
SERVER_SYMLINK_ROSTER="$CONFIG_AUX_DIR/${SERVER_SYMLINK##*/}.roster"
XF86CONFIG_CHECKSUM="$CONFIG_AUX_DIR/${XF86CONFIG##*/}.md5sum"
XORGCONFIG_CHECKSUM="$CONFIG_AUX_DIR/${XORGCONFIG##*/}.md5sum"
XF86CONFIG_ROSTER="$CONFIG_AUX_DIR/${XF86CONFIG##*/}.roster"
XORGCONFIG_ROSTER="$CONFIG_AUX_DIR/${XORGCONFIG##*/}.roster"
THIS_SERVER=/usr/bin/Xorg

if [ -e "$CONFIG_AUX_DIR/.migrateconfig" ]; then
  AUTODETECT_VIDEO="yes"
  rm -f $CONFIG_AUX_DIR/.migrateconfig
fi

if [ -n "$DEBUG_XORG_PACKAGE" ]; then
  XRESPROBE_DEBUG="yes"
fi

#DEBHELPER#

xresprobeint() {
  PRIORITY="medium"
  db_input $PRIORITY xserver-xorg/autodetect_monitor || debug_echo "db_get xserver-xorg/autodetect_monitor"
  db_go
  db_get xserver-xorg/autodetect_monitor || debug_echo "db_get xserver-xorg/autodetect_monitor"
  # well, you'd better like the values you get, eh?
  if [ "$RET" = "true" ]; then
    AUTODETECT_VIDEO="yes"
  fi
  if [ -n "$AUTODETECT_VIDEO" ] && [ -z "$UPGRADE" ]; then
    # clean vars
    MONITOR_IDENTIFIER=
    RESOLUTIONS=
    HORIZ_SYNC=
    VERT_REFRESH=

    # clear out all values
    for i in identifier horiz-sync vert-refresh use_sync_ranges \
             selection-method screen-size; do
      db_reset xserver-xorg/config/monitor/$i
    done

    for i in modes; do
      db_reset xserver-xorg/config/display/$i
    done
    # Support preseeding of this one even when autodetecting; will mean
    # people get the wrong default presented on second and subsequent
    # low-priority reconfigures, though. Too bad.
    for i in default_depth; do
      db_fget xserver-xorg/config/display/$i seen
      if [ "$RET" = false ]; then
        db_reset xserver-xorg/config/display/$i
      fi
    done
    
    db_get xserver-xorg/config/device/driver || debug_echo "db_get xserver-xorg/config/device/driver"
    DEVICE_DRIVER="$RET"
    db_get xserver-xorg/config/device/identifier || debug_echo "db_get xserver-xorg/config/device/driver"
    DEVICE_IDENTIFIER="$RET"

    # first install, we attempt a probe
    if which xresprobe >/dev/null 2>&1; then
      set +e
      PROBE_DUMP="$(xresprobe "$DEVICE_DRIVER")"
      set -e
    fi

    # Set proper vars.
    MONITOR_IDENTIFIER="$(echo "$PROBE_DUMP" | grep "^id:" | sed -e 's/^id: //g' -e 's/"//g')"
    RESOLUTIONS="$(echo "$PROBE_DUMP" | grep "^res:" | sed -e 's/^res: //g')"
    HORIZ_SYNC="$(echo "$PROBE_DUMP" | grep "^freq:" | sed -e 's/^freq: //g' | cut -d " " -f 1)"
    VERT_REFRESH="$(echo "$PROBE_DUMP" | grep "^freq:" | sed -e 's/^freq: //g' | cut -d " " -f 2)"
    DISPLAY_TYPE="$(echo "$PROBE_DUMP" | grep "^disptype:" | sed -e 's/^disptype: //g')"
    DISPLAY_DEPTH="$(echo "$PROBE_DUMP" | grep "^depth:" | sed -e 's/^depth: //g')"

    if [ -n "$XORG_SYNC_RANGES" ]; then
      debug_echo "writing sync ranges due to XORG_SYNC_RANGES"
      MONITOR_SYNC_RANGES="yes"
    fi
  
    # nv, savage, trident and via will take the panel resolution from a BIOS table,
    # but  then fail to infer sane sync ranges from these, so mode validation will
    # fail when it uses the standard VGA sync ranges.  hack around this by producing
    # a sane sync range for the resolution in the config file when they're almost
    # certain to be using LVDS.
    if [ "$DEVICE_DRIVER" = "nv" ] || [ "$DEVICE_DRIVER" = "savage" ] || \
       [ "$DEVICE_DRIVER" = "trident" ] || [ "$DEVICE_DRIVER" = "via" ] || \
       [ "$DEVICE_DRIVER" = "siliconmotion" ] || \
       [ "$DEVICE_DRIVER" = "chips" ] || [ "$DEVICE_DRIVER" = "tdfx" ] || \
       [ "$DEVICE_DRIVER" = "neomagic" ]; then
      if [ "$DISPLAY_TYPE" = "lcd/lvds" ]; then
        debug_echo "known-bad laptop chipset detected; writing sync ranges"
        MONITOR_SYNC_RANGES="yes"
      fi
    fi

    if [ "$DEVICE_DRIVER" = "s3" ]; then
      debug_echo "known-bad chipset detected; writing sync ranges"
      MONITOR_SYNC_RANGES="yes"
    fi

    if [ "$DEVICE_DRIVER" = "ati" ]; then
      # r128 is in the same 'special' list, AFAICT.
      if [ "$DISPLAY_TYPE" = "lcd/lvds" ]; then
        if [ "$DEVICE_IDENTIFIER" = "ATI Technologies, Inc. Rage Mobility M3 (AGP)" ] || \
           [ "$DEVICE_IDENTIFIER" = "ATI Technologies, Inc. Rage Mobility M4 (AGP)" ] || \
           echo "$DEVICE_IDENTIFIER" | grep -q "Rage 128"; then
          MONITOR_SYNC_RANGES="yes"
          debug_echo "r128 laptop chipset detected; writing sync ranges"
        fi
      else
        # ddc via i2c on ati/powerpc seems to be too flaky to be relied upon
        if [ "$ARCHITECTURE" = "powerpc" ]; then
          MONITOR_SYNC_RANGES="yes"
          debug_echo "ati chipset on powerpc detected; writing sync ranges"
        fi
      fi
    fi

    if [ "$DEVICE_DRIVER" = "i810" ]; then
      # and i810, but *not* i830
      if [ "$DISPLAY_TYPE" = "lcd/lvds" ]; then
        if [ "$DEVICE_IDENTIFIER" = "Intel Corporation 82810 CGC [Chipset Graphics Controller]" ] || \
           [ "$DEVICE_IDENTIFIER" = "Intel Corporation 82810 DC-100 CGC [Chipset Graphics Controller]" ] || \
           [ "$DEVICE_IDENTIFIER" = "Intel Corporation 82810E DC-133 CGC [Chipset Graphics Controller]" ] || \
           [ "$DEVICE_IDENTIFIER" = "Intel Corporation 82815 CGC [Chipset Graphics Controller]" ]; then
          MONITOR_SYNC_RANGES="yes"
          debug_echo "i810 laptop chipset detected; writing sync ranges"
        fi
      fi
    fi
  else
    # reconfiguring. debconf should have sane defaults
    db_get xserver-xorg/config/monitor/identifier || debug_echo "db_get xserver-xorg/config/monitor/identifier"
    MONITOR_IDENTIFIER="$RET"
    db_get xserver-xorg/config/display/modes || debug_echo "db_get xserver-xorg/config/display/modes"
    RESOLUTIONS=$(echo "$RET" | sed -e 's/,//g')
    db_get xserver-xorg/config/monitor/horiz-sync || debug_echo "db_get xserver-xorg/config/monitor/horiz-sync"
    HORIZ_SYNC="$RET"
    db_get xserver-xorg/config/monitor/vert-refresh || debug_echo "db_get xserver-xorg/config/monitor/vert-refresh"
    VERT_REFRESH="$RET"
    db_get xserver-xorg/config/monitor/use_sync_ranges || debug_echo "db_get xserver-xorg/config/monitor/use_sync_ranges"
    if [ "$RET" = "true" ]; then
      MONITOR_SYNC_RANGES="yes"
      debug_echo "preserving sync ranges from debconf"
    fi
  fi

  # Set a sane monitor id default if probe fails
  if [ -z "$MONITOR_IDENTIFIER" ]; then
    case "${LC_ALL:-${LC_MESSAGES:-$LANG}}" in
      ca_*) DEFAULT="Monitor genèric" ;;
      da_*) DEFAULT="Standard Skærm" ;;
      de_*) DEFAULT="Standardbildschirm" ;;
      es_*) DEFAULT="Monitor genérico" ;;
      fr_*) DEFAULT="Écran générique";;
      it_*) DEFAULT="Monitor Generico" ;;
      pt_BR) DEFAULT="Monitor Genérico" ;;
      *) DEFAULT="Generic Monitor" ;;
    esac
    MONITOR_IDENTIFIER="$DEFAULT"
  fi
  db_set xserver-xorg/config/monitor/identifier "$MONITOR_IDENTIFIER"
  MAY_BE_NULL="" validate_string_db_input low xserver-xorg/config/monitor/identifier || true


  # Resolution hell:
  # we need to know if we probed resolutions, if so add them to debconf template
  # as choices, so that we don't lose them across updates or reconfiguration.
  PRIORITY="high"
  if [ -n "$AUTODETECT_VIDEO" ]; then
    NRES=0
    for i in $RESOLUTIONS; do
      NRES="$(expr $NRES + 1)"
    done

    if [ "$NRES" -gt "0" ]; then
      # got RESOLUTIONS. Lower question priority
      PRIORITY=medium
      DCRESOLUTIONS="$(for i in $DCRESOLUTIONS $RESOLUTIONS; do echo $i; done | sort -t x -k1,1nr -k2,2nr -u)"
      DCRESOLUTIONS="$(echo $DCRESOLUTIONS | sed -e 's/ /, /g')"
    fi

    # if we're not running an internal panel and we don't have a list of sync
    # ranges, X isn't going to be able to figure it out; give it a hand
    if [ -z "$UPGRADE" ]; then
      if ! [ "$DISPLAY_TYPE" = "lcd/lvds" ]; then
        if [ -z "$HORIZ_SYNC" ] || [ -z "$VERT_REFRESH" ]; then
          # the actual default sync ranges are calculated further down
          MONITOR_SYNC_RANGES="yes"
          debug_echo "no sync ranges available from DDC; writing own ranges"
        fi
      fi
    fi
  fi

  if [ -n "$UPGRADE" ]; then
    # drop priority on upgrades
    PRIORITY="medium"
  fi

  db_metaget xserver-xorg/config/display/modes choices
  DEFRESOLUTIONS="1920x1440 1920x1200 1856x1392 1792x1344 1680x1050 1600x1200 1440x900 1400x1050 1280x1024 1280x960 1280x854 1280x800 1280x768 1200x800 1152x864 1152x768 1024x768 800x600 640x480"
  if [ -n "$RET" ]; then
    DCRESOLUTIONS="$RET"
    DCRESOLUTIONS="$(echo $DCRESOLUTIONS | sed -e 's/, / /g')"
  fi
  if [ -n "$RESOLUTIONS" ]; then
    DCRESOLUTIONS="$(for i in $DCRESOLUTIONS $DEFRESOLUTIONS $RESOLUTIONS; do echo $i; done | sort -t x -k1,1nr -k2,2nr -u)"
  fi
  # set the old choice + the probed ones (if any).
  DCRESOLUTIONS="$(echo $DCRESOLUTIONS | sed -e 's/ /, /g')"
  db_subst xserver-xorg/config/display/modes choices "$DCRESOLUTIONS"
  if [ -n "$RESOLUTIONS" ]; then
    RESOLUTIONS="$(echo $RESOLUTIONS | sed -e 's/ /, /g')"
    db_set xserver-xorg/config/display/modes "$RESOLUTIONS"
  fi
  db_input $PRIORITY xserver-xorg/config/display/modes || debug_echo "db_input $PRIORITY xserver-xorg/config/display/modes"
  db_go

  db_subst xserver-xorg/config/monitor/selection-method choices "Simple, Medium, Advanced"
  db_subst xserver-xorg/config/monitor/selection-method default "Medium"

  if [ -n "$AUTODETECT_VIDEO" ]; then
    if [ -n "$HORIZ_SYNC" ] && [ -n "$VERT_REFRESH" ]; then
      # monitor frequencies detected, we set them as defaults and we switch to Advanced mode.
      # there is no need to get crazy feeding "Medium"
      db_set xserver-xorg/config/monitor/horiz-sync "$HORIZ_SYNC"
      db_set xserver-xorg/config/monitor/vert-refresh "$VERT_REFRESH"
      db_set xserver-xorg/config/monitor/selection-method "Advanced"
    else
      # if we are here we did not detect the frequencies, but we have the resolution.
      # get the highest resolution.
      db_get xserver-xorg/config/display/modes || debug_echo "db_get xserver-xorg/config/display/modes"
      if [ -z "$RET" ]; then
        _ok=""
        while [ ! "$ok" ]; do
          db_input $PRIORITY xserver-xorg/config/display/modes || debug_echo "db_input $PRIORITY xserver-xorg/config/display/modes"
          if [ $? -eq 30 ]; then
            _ok="yes"
          else
            db_go || true
            db_get xserver-xorg/config/display/modes
            if [ "$RET" ]; then
              _ok="yes"
            fi
          fi
        done
      fi
      MAXRES="$(echo $RET | sed -e 's/,//g')"
      MAXRES="$(for i in $MAXRES; do echo $i; done | sort -t x -k1,1nr -k2,2nr -u | head -n 1)"
      # set a sane default for mode-list
      MAXRES="$MAXRES @ 60Hz"
      db_set xserver-xorg/config/monitor/mode-list "$MAXRES"
      # apparently all the known resolution/horiz-sync combinantion have a ratio that
      # can go from 19 to 21. Only one exception was 18. We can safely assume a ratio of 20
      # for default setup. DDC should do the rest.
      HMAX=$(echo "$MAXRES" | cut -d "x" -f 1)
      HMAX=$(expr "$HMAX" / 20)
      # set sane defaults as fallback, in case there is no mode-list match otherwise we
      # prefer a well known match.
      HORIZ_SYNC="28-$HMAX"
      VERT_REFRESH="43-60"
      db_set xserver-xorg/config/monitor/horiz-sync "$HORIZ_SYNC"
      db_set xserver-xorg/config/monitor/vert-refresh "$VERT_REFRESH"
      db_set xserver-xorg/config/monitor/selection-method "Advanced"
    fi
  fi

  db_input low xserver-xorg/config/monitor/selection-method || debug_echo "db_input low xserver-xorg/config/monitor/selection-method"
  db_go

  db_get xserver-xorg/config/monitor/selection-method
  case "$RET" in
    Simple)
      db_input low xserver-xorg/config/monitor/screen-size || debug_echo "db_input low xserver-xorg/config/monitor/screen-size"
      db_go
      db_get xserver-xorg/config/monitor/screen-size
      case "$RET" in
        'Up to 14 inches (355 mm)')
          db_set xserver-xorg/config/monitor/horiz-sync "28-33"
          db_set xserver-xorg/config/monitor/vert-refresh "43-72"
          ;;
        '15 inches (380 mm)')
          db_set xserver-xorg/config/monitor/horiz-sync "28-50"
          db_set xserver-xorg/config/monitor/vert-refresh "43-75"
          ;;
        '17 inches (430 mm)')
          db_set xserver-xorg/config/monitor/horiz-sync "30-70"
          db_set xserver-xorg/config/monitor/vert-refresh "50-160"
          ;;
        '19-20 inches (480-510 mm)')
          db_set xserver-xorg/config/monitor/horiz-sync "30-100"
          db_set xserver-xorg/config/monitor/vert-refresh "50-160"
          ;;
        '21 inches (530 mm) or more')
          db_set xserver-xorg/config/monitor/horiz-sync "30-130"
          db_set xserver-xorg/config/monitor/vert-refresh "50-160"
          ;;
      esac
      ;;
    Medium)
      db_input low xserver-xorg/config/monitor/mode-list || true
      db_go
      if [ -n "$MAXRES" ]; then
        RET="$MAXRES"
      else
        db_get xserver-xorg/config/monitor/mode-list
      fi
      case "$RET" in
        "640x480 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "28-33"
          db_set xserver-xorg/config/monitor/vert-refresh "43-72"
          ;;
        "640x480 @ 72Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "28-38"
          db_set xserver-xorg/config/monitor/vert-refresh "43-72"
          ;;
        "800x600 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "28-38"
          db_set xserver-xorg/config/monitor/vert-refresh "43-72"
          ;;
        "800x600 @ 72Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "28-48"
          db_set xserver-xorg/config/monitor/vert-refresh "43-72"
          ;;
        "800x600 @ 85Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-54"
          db_set xserver-xorg/config/monitor/vert-refresh "50-85"
          ;;
        "832x624 @ 75Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-50"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1024x768 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "28-49"
          db_set xserver-xorg/config/monitor/vert-refresh "43-72"
          ;;
        "1024x768 @ 70Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-57"
          db_set xserver-xorg/config/monitor/vert-refresh "43-72"
          ;;
        "1024x768 @ 75Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-60"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1152x768 @ 54.8Hz")
          # This is a 15" PowerBook G4 mode; its video hardware (LCD) was also
          # capable of 896x600 and 720x480 pixels at a 3:2 aspect ratio and
          # 1024x768, 800x600, and 640x480 pixels at a 4:3 aspect ratio, so give
          # its horizontal and vertical ranges a little more "headroom" than
          # that required by this specific mode to accomodate the others.
          db_set xserver-xorg/config/monitor/horiz-sync "30-50"
          db_set xserver-xorg/config/monitor/vert-refresh "50-72"
          ;;
        "1152x864 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-68"
          db_set xserver-xorg/config/monitor/vert-refresh "50-70"
          ;;
        "1152x864 @ 75Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-68"
          db_set xserver-xorg/config/monitor/vert-refresh "50-85"
          ;;
        "1280x768 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-65"
          db_set xserver-xorg/config/monitor/vert-refresh "30-60"
          ;;
        "1280x800 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-67"
          db_set xserver-xorg/config/monitor/vert-refresh "30-60"
          ;;
        "1280x960 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-60"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1280x960 @ 85Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-92"
          db_set xserver-xorg/config/monitor/vert-refresh "50-85"
          ;;
        "1280x1024 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-65"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1400x1050 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-67"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1400x1050 @ 75Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-85"
          db_set xserver-xorg/config/monitor/vert-refresh "50-80"
          ;;
        "1600x1024 @ 85Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-70"
          db_set xserver-xorg/config/monitor/vert-refresh "50-90"
          ;;
        "1600x1200 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-75"
          db_set xserver-xorg/config/monitor/vert-refresh "50-85"
          ;;
        "1600x1200 @ 75Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-94"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1600x1200 @ 85Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-107"
          db_set xserver-xorg/config/monitor/vert-refresh "50-85"
          ;;
        "1680x1050 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-90"
          db_set xserver-xorg/config/monitor/vert-refresh "50-60"
          ;;
        "1792x1344 @ 75Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-107"
          db_set xserver-xorg/config/monitor/vert-refresh "50-85"
          ;;
        "1792x1344 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-84"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1856x1392 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-87"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1856x1392 @ 75Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-113"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1920x1200 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-75"
          db_set xserver-xorg/config/monitor/vert-refresh "30-60"
          ;;
        "1920x1440 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-90"
          db_set xserver-xorg/config/monitor/vert-refresh "50-75"
          ;;
        "1920x1440 @ 75Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-130"
          db_set xserver-xorg/config/monitor/vert-refresh "60-160"
          ;;
        "1920x1440 @ 85Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-130"
          db_set xserver-xorg/config/monitor/vert-refresh "60-160"
          ;;
        "2048x1536 @ 60Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-100"
          db_set xserver-xorg/config/monitor/vert-refresh "60-85"
          ;;
        "2048x1536 @ 75Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-125"
          db_set xserver-xorg/config/monitor/vert-refresh "60-100"
          ;;
        "2048x1536 @ 85Hz")
          db_set xserver-xorg/config/monitor/horiz-sync "30-140"
          db_set xserver-xorg/config/monitor/vert-refresh "60-160"
          ;;
      esac
      ;;
    Advanced)
      validate_monitor_frequency_db_input low xserver-xorg/config/monitor/horiz-sync || true
      validate_monitor_frequency_db_input low xserver-xorg/config/monitor/vert-refresh || true
      db_go
      ;;
  esac

  # don't write sync ranges if it's exactly what we picked up from DDC
  db_get xserver-xorg/config/monitor/horiz-sync
  USER_HSYNC="$RET"
  db_get xserver-xorg/config/monitor/vert-refresh
  USER_VREFRESH="$RET"
  if [ -z "$UPGRADE" ]; then
    if [ -n "$AUTODETECT_VIDEO" ]; then
       if ! [ "$USER_HSYNC" = "$HORIZ_SYNC" ] || \
          ! [ "$USER_VREFRESH" = "$VERT_REFRESH" ]; then
        MONITOR_SYNC_RANGES="yes"
        debug_echo "writing out user-customised sync ranges"
       fi
    else
      # always write them out if we refused probing for some reason
      MONITOR_SYNC_RANGES="yes"
      debug_echo "not probing; writing out sync ranges"
    fi
    # we don't do anything here because we're just upgrading; leave it alone.
  fi

  if [ -n "$MONITOR_SYNC_RANGES" ]; then
    db_set xserver-xorg/config/monitor/use_sync_ranges true
  fi
  db_input low xserver-xorg/config/monitor/use_sync_ranges || debug_echo "db_input low xserver-xorg/config/monitor/use_sync_ranges"

  case "$DEVICE_DRIVER" in
    newport)
      DEFAULT_DEPTH=8
      ;;
    vga)
      DEFAULT_DEPTH=4
      ;;
    # Voodoo3's can't do 1024x768x24 and still cope with DRI; this is a common
    # setup, apparently, so default to 16bpp.
    tdfx)
      DEFAULT_DEPTH=16
      ;;
    # nVidia laptop chipsets should use 16bpp per default, or face horrific
    # colour banding issues, per Olivier Grawert and Trent Lloyd.
    nv)
      if [ -n "$LAPTOP" ]; then
        DEFAULT_DEPTH=16
      else
        DEFAULT_DEPTH=24
      fi
      ;;
    # apparently this driver needs some hot hot depth action too.
    savage)
      DEFAULT_DEPTH=16
      ;;
    *)
      DEFAULT_DEPTH=24
      ;;
  esac

  if [ -n "$DISPLAY_DEPTH" ]; then
    DEFAULT_DEPTH="$DISPLAY_DEPTH"
  fi

  db_fget xserver-xorg/config/display/default_depth seen
  if [ "$RET" = "false" ]; then
    db_set xserver-xorg/config/display/default_depth $DEFAULT_DEPTH
  fi

  db_input low xserver-xorg/config/display/default_depth || true
  db_go
}

# register this package as a (potential) handler of the X server symlink and
# X.Org X server configuration file
for ROSTER in "$SERVER_SYMLINK_ROSTER" "$XORGCONFIG_ROSTER"; do
  if ! fgrep -qsx "$THIS_PACKAGE" "$ROSTER"; then
    echo "$THIS_PACKAGE" >> "$ROSTER"
  fi
done

# only mess with the server symlink file if it is a symbolic link or does
# not exist.  otherwise, assume that's the way the user wants it.
if [ -L "$SERVER_SYMLINK" ] || ! [ -e "$SERVER_SYMLINK" ]; then
  # migrate from old symlinks.
  if [ "$(readlink /etc/X11/X)" = "/usr/X11R6/bin/Xorg" ] || \
     [ "$(readlink /etc/X11/X)" = "/usr/bin/X11/Xorg" ] || \
     [ "$(readlink /etc/X11/X)" = "/bin/true" ]; then
    rm /etc/X11/X
    ln -s $THIS_SERVER /etc/X11/X
  fi
  # compare the current and stored checksums; if they do not match, assume
  # that's the way the user wants it.
  # why, why, why, why, why, why, why are we md5suming this? -daniels
  if [ "$(readlink "$SERVER_SYMLINK" | md5sum)" = \
       "$(cat "$SERVER_SYMLINK_CHECKSUM")" ] || \
     [ "$(echo "/usr/X11R6/bin/Xorg" | md5sum)" = \
       "$(cat "$SERVER_SYMLINK_CHECKSUM")" ] || \
     [ "$(echo "/usr/bin/X11/Xorg" | md5sum)" = \
       "$(cat "$SERVER_SYMLINK_CHECKSUM")" ] || \
     ! [ -e "$SERVER_SYMLINK" ]; then
    # finally, only update the symlink if this package contains the
    # selected default X server.
    db_get shared/default-x-server
    if [ -n "$RET" ]; then
      SELECTED_PACKAGE="$RET"
      if [ "$SELECTED_PACKAGE" = "$THIS_PACKAGE" ]; then
        # prepare a new version of the config file; this is a symlink so we
        # can't use the tempfile command for it (we'd have to subsequently
        # use ln -sf, which is subject to race condition attacks)
        NEW_SERVER_SYMLINK="$SERVER_SYMLINK.dpkg-new"
        ln -sf "$THIS_SERVER" "$NEW_SERVER_SYMLINK"
        if ! cmp -s "$SERVER_SYMLINK" "$NEW_SERVER_SYMLINK"; then
          if [ "$(readlink "$SERVER_SYMLINK")" \
               != "$(readlink "$NEW_SERVER_SYMLINK")" ]; then
            mv "$NEW_SERVER_SYMLINK" "$SERVER_SYMLINK"
            readlink "$SERVER_SYMLINK" | md5sum > \
                     "$SERVER_SYMLINK_CHECKSUM"
          fi
        fi
        rm -f "$NEW_SERVER_SYMLINK"
      fi
    else
      warn "not updating $SERVER_SYMLINK; no default X server" \
           "configured; run \"dpkg-reconfigure $THIS_PACKAGE\" to" \
           "correct this"
    fi
  else
    warn "not updating $SERVER_SYMLINK; file has been customized"
  fi
else
  warn "not updating $SERVER_SYMLINK; file exists but is not a symlink"
fi

# here's a novel concept: DON'T TOUCH THE CONFIG ON UPGRADES
if [ -z "$UPGRADE" ] || [ dpkg --compare-versions "$2" le "1:7.0.14" ]; then
  # compare the current and stored checksums; if they do not match, assume
  # that's the way the user wants it.  if we're reconfiguring, overwrite
  # it regardless and back it up.
  if [ "$(md5sum "$XORGCONFIG")" = "$(cat "$XORGCONFIG_CHECKSUM")" ] || \
     ! [ -e "$XORGCONFIG" ] || [ -n "$RECONFIGURE" ]; then
    # they match or user deleted the file; prepare a new version
    NEW_XORGCONFIG="$XORGCONFIG.dpkg-new"
    if [ -n "$XRESPROBE_DEBUG" ]; then
      set -x
    fi
    xresprobeint
    if [ -n "$XRESPROBE_DEBUG" ]; then
      set +x
    fi
    if [ -n "$RECONFIGURE" ] && [ -e "$XORGCONFIG" ]; then
      BACKUP_XORGCONFIG="$XORGCONFIG.$(date '+%Y%m%d%H%M%S')"
      if [ -e "$BACKUP_XORGCONFIG" ]; then
        bomb "backup xorg.conf file $BACKUP_XORGCONFIG already" \
             "exists; please remove it and try again"
      fi
      cp "$XORGCONFIG" "$BACKUP_XORGCONFIG"
      warn "overwriting possibly-customised configuration file; backup" \
           "in $BACKUP_XORGCONFIG"
    fi
    if dexconf -o "$NEW_XORGCONFIG"; then
      if ! cmp -s "$XORGCONFIG" "$NEW_XORGCONFIG"; then
        mv "$NEW_XORGCONFIG" "$XORGCONFIG"
        md5sum "$XORGCONFIG" > "$XORGCONFIG_CHECKSUM"
      fi
    else
      warn "error while preparing new Xorg X server configuration" \
           "file in $NEW_XORGCONFIG; not attempting to update existing" \
           "configuration"
    fi
    rm -f "$NEW_XORGCONFIG"
  else
    # I'm going to get in so much shit for this...
    warn "$XORGCONFIG has been customized, but we need to make updates. Backing up your config to $BACKUP_XORGCONFIG. If we screw something up, restore using this file."
      cp "$XORGCONFIG" "$BACKUP_XORGCONFIG"
    sed -e'
	# Dump obsolete modules
	/^[[:space:]]*Section[[:space:]]\+"Module"[[:space:]]*$/,/^[[:space:]]*EndSection[[:space:]]*$/ {
		/^[[:space:]]*Load[[:space:]]\+"GLcore"[[:space:]]*$/d
		/^[[:space:]]*Load[[:space:]]\+"speedo"[[:space:]]*$/d
	}
	/^[[:space:]]*Section[[:space:]]\+"Files"[[:space:]]*$/,/*[[:space:]]*EndSection[[:space:]]*$/ {
		# Delete the module path
		/^[[:space:]]*ModulePath[[:space:]]\+/d
		# Delete the rgb path
		/^[[:space:]]*RgbPath[[:space:]]\+/d
		# Change font paths for the fonts xorg-x11 used to ship
		#/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/share\/fonts\/X11\/misc"[[:space:]]*$/d
		#/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/share\/fonts\/X11\/cyrillic"[[:space:]]*$/d
		#/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/share\/fonts\/X11\/100dpi"[[:space:]]*$/d
		#/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/share\/fonts\/X11\/75dpi"[[:space:]]*$/d
		#/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/share\/fonts\/X11\/Type1"[[:space:]]*$/d
		#/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/share\/fonts\/X11\/CID"[[:space:]]*$/d
		#/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/share\/fonts\/X11\/Speedo"[[:space:]]*$/d
		/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/lib\/X11\/fonts\/misc"[[:space:]]*$/i\
	FontPath	"/usr/share/fonts/X11/misc"
		/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/lib\/X11\/fonts\/cyrillic"[[:space:]]*$/i\
	FontPath	"/usr/share/fonts/X11/cyrillic"
		/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/lib\/X11\/fonts\/100dpi"[[:space:]]*$/i\
	FontPath	"/usr/share/fonts/X11/100dpi"
		/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/lib\/X11\/fonts\/75dpi"[[:space:]]*$/i\
	FontPath	"/usr/share/fonts/X11/75dpi"
		/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/lib\/X11\/fonts\/Type1"[[:space:]]*$/i\
	FontPath	"/usr/share/fonts/X11/Type1"
		/^[[:space:]]*FontPath[[:space:]]\+"\/usr\/lib\/X11\/fonts\/CID"[[:space:]]*$/i\
	FontPath	"/usr/share/fonts/X11/CID"
	}
	' $XORGCONFIG > ${XORGCONFIG}.madwizard-new
	chown --reference=$XORGCONFIG ${XORGCONFIG}.madwizard-new
	chmod --reference=$XORGCONFIG ${XORGCONFIG}.madwizard-new
	mv ${XORGCONFIG}.madwizard-new $XORGCONFIG
  fi
else
  debug_echo "not updating $XORGCONFIG; we're upgrading"
fi

exit 0

# vim:set ai et sts=2 sw=2 tw=0:
