#!/bin/sh
# Debian xfree86-common package post-installation script
# Copyright 1998--2001, 2003 Branden Robinson.
# Licensed under the GNU General Public License, version 2.  See the file
# /usr/share/common-licenses/GPL or <http://www.gnu.org/copyleft/gpl.txt>.
# Acknowlegements to Stephen Early, Mark Eichin, and Manoj Srivastava.

set -e

. /usr/share/debconf/confmodule

THIS_PACKAGE=xfree86-common
THIS_SCRIPT=postinst
CONFIG_DIR=/etc/X11
XWRAPPER_CONFIG="$CONFIG_DIR/Xwrapper.config"
CONFIG_AUX_DIR=/var/lib/x11
XWRAPPER_CONFIG_CHECKSUM_BASE="${XWRAPPER_CONFIG##*/}.md5sum"
XWRAPPER_CONFIG_CHECKSUM="$CONFIG_AUX_DIR/$XWRAPPER_CONFIG_CHECKSUM_BASE"
XWRAPPER_CONFIG_ROSTER_BASE="${XWRAPPER_CONFIG##*/}.roster"
XWRAPPER_CONFIG_ROSTER="$CONFIG_AUX_DIR/$XWRAPPER_CONFIG_ROSTER_BASE"

#INCLUDE_SHELL_LIB#

# de-register this package as a handler of the X server wrapper config file
if [ -e "$XWRAPPER_CONFIG_ROSTER" ]; then
  # check existing roster file for our package name
  if fgrep -qx "$THIS_PACKAGE" "$XWRAPPER_CONFIG_ROSTER" 2>/dev/null; then
    # construct temporary roster file with our package name removed, ignoring
    # failure
    fgrep -vx "$THIS_PACKAGE" "$XWRAPPER_CONFIG_ROSTER" > \
      "$XWRAPPER_CONFIG_ROSTER.dpkg-tmp" 2>/dev/null || true
    # is there anything left?
    if [ -s "$XWRAPPER_CONFIG_ROSTER.dpkg-tmp" ]; then
      # yes, replace the roster file
      mv "$XWRAPPER_CONFIG_ROSTER.dpkg-tmp" "$XWRAPPER_CONFIG_ROSTER"
    else
      # no; remove both the roster and our temporary copy
      rm -f "$XWRAPPER_CONFIG_ROSTER" "$XWRAPPER_CONFIG_ROSTER.dpkg-tmp"
      # remove X server wrapper config file if it was still managed by the
      # package
      if [ -e "$XWRAPPER_CONFIG_CHECKSUM" ]; then
        # does it exist?
        if [ -e "$XWRAPPER_CONFIG" ]; then
          # does the current MD5 checksum match the stored checksum?
          if [ "$(md5sum "$XWRAPPER_CONFIG")" \
               = "$(cat "$XWRAPPER_CONFIG_CHECKSUM")" ]; then
            # yes; remove the config file
            rm -f "$XWRAPPER_CONFIG"
          fi
        fi
        # remove the checksum file; any remaining X server wrapper config file
        # still on the system at this point is no longer being managed (local
        # user customization)
        rm -f "$XWRAPPER_CONFIG_CHECKSUM"
      fi
    fi
  fi
fi

# Just move the Xsession file if it's still around
if [ -f /etc/X11/Xsession ]; then
  mv /etc/X11/Xsession /etc/X11/Xsession.xfree86
fi

if [ $1 = "purge" ]; then
  # Remove the old xfree86-common stuff in Xsession.d
  for FILE in 20xfree86-common_process-args 30xfree86-common_xresources 50xfree86-common_determine-startup 90xfree86-common_ssh-agent 99xfree86-common_start; do
    rm /etc/X11/Xsession.d/$FILE
  done
fi

#DEBHELPER#

exit 0

# vim:set ai et sts=2 sw=2 tw=80:
