#!/bin/sh
# Debian xserver-xorg package pre-removal script
# Copyright 1998--2001, 2003, 2004 Branden Robinson.
# Licensed under the GNU General Public License, version 2.  See the file
# /usr/share/common-licenses/GPL or <http://www.gnu.org/copyleft/gpl.txt>.
# Acknowledgements to Stephen Early, Mark Eichin, and Manoj Srivastava.


set -e

# debconf may not be available if some massive purging is going on
HAVE_DEBCONF=
if [ -e /usr/share/debconf/confmodule ]; then
  . /usr/share/debconf/confmodule
  HAVE_DEBCONF=yes
fi

THIS_PACKAGE=xserver-xorg
THIS_SCRIPT=prerm

#INCLUDE_SHELL_LIB#

CONFIG_DIR=/etc/X11
SERVER_SYMLINK="$CONFIG_DIR/X"
CONFIG_AUX_DIR=/var/lib/x11
SERVER_SYMLINK_CHECKSUM="$CONFIG_AUX_DIR/${SERVER_SYMLINK##*/}.md5sum"
UNCONFIGURED_LINK_TARGET=$(which true)

if [ "$1" = "remove" ] || [ "$1" = "deconfigure" ]; then
  # if the X server symlink is under automatic management, we are removing its
  # target; we must re-set it to its "unconfigured default"

  # first, only mess with config files if the configuration file auxiliary
  # directory exists; if it does not, assume that's the way the user wants it
  if [ -d "$CONFIG_AUX_DIR" ]; then
    # only mess with the server symlink file it exists and is actually a
    # symlink; otherwise, assume that's the way the user wants it
    if [ -L "$SERVER_SYMLINK" ]; then
      # similarly, check for the existence of the checksum file; if it doesn't
      # exist, assume that's the way the user wants it
      if [ -e "$SERVER_SYMLINK_CHECKSUM" ]; then
        # compare the current and stored checksums; if they do not match,
        # assume that's the way the user wants it
        if [ "$(readlink "$SERVER_SYMLINK" | md5sum)" = \
             "$(cat "$SERVER_SYMLINK_CHECKSUM")" ]; then
          # prepare a new version of the config file; this is a symlink, so we
          # can't use the tempfile command for it (we'd have to subsequently
          # use ln -sf, which is subject to race condition attacks)
          NEW_SERVER_SYMLINK="$SERVER_SYMLINK.dpkg-new"
          ln -sf "$UNCONFIGURED_LINK_TARGET" "$NEW_SERVER_SYMLINK"
          if ! cmp -s "$SERVER_SYMLINK" "$NEW_SERVER_SYMLINK"; then
            if [ "$(readlink "$SERVER_SYMLINK")" \
                 != "$(readlink "$NEW_SERVER_SYMLINK")" ]; then
              if ! [ -d "$SERVER_SYMLINK" ]; then
                warn "X server provided by $THIS_PACKAGE package is being" \
                     "removed; setting $SERVER_SYMLINK to point to" \
                     "$UNCONFIGURED_LINK_TARGET"
                mv "$NEW_SERVER_SYMLINK" "$SERVER_SYMLINK"
                readlink "$SERVER_SYMLINK" | md5sum > \
                         "$SERVER_SYMLINK_CHECKSUM"
              fi
            fi
          fi
          rm -f "$NEW_SERVER_SYMLINK"
        fi
      fi
    fi
  fi

  if [ -n "$HAVE_DEBCONF" ]; then
    # disown this question
    db_unregister shared/default-x-server
    # does the question still exist?
    if db_get shared/default-x-server; then
      db_metaget shared/default-x-server owners
      db_subst shared/default-x-server choices "$RET"
      db_metaget shared/default-x-server value
      if [ "$THIS_PACKAGE" = "$RET" ]; then
        db_fset shared/default-x-server seen false
        db_input critical shared/default-x-server || true
        db_go
        db_get shared/default-x-server
        warn "run \"dpkg-reconfigure $RET\" before attempting to start the X" \
             "server again"
      fi
    fi
  fi
fi

#DEBHELPER#

exit 0

# vim:set ai et sts=2 sw=2 tw=0:
